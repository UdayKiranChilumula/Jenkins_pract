pipeline {
    agent any

    environment {
        REMOTE_HOST = "44.204.13.61"
    }

    stages {
        stage('Install Nginx via SSH (No Plugin)') {
            steps {
                withCredentials([
                    sshUserPrivateKey(credentialsId: 'ssh-private-key-ec2', keyFileVariable: 'SSH_KEY', usernameVariable: 'SSH_USER')
                ]) {
                    sh '''
                        echo "Setting up SSH private key permissions..."
                        chmod 600 $SSH_KEY

                        echo "Connecting to remote host and installing Nginx..."

                        ssh -i $SSH_KEY -o StrictHostKeyChecking=no $SSH_USER@$REMOTE_HOST << 'ENDSSH'
                            set -e
                            echo "Updating system..."
                            if [ -f /etc/redhat-release ]; then
                                sudo yum update -y
                                sudo yum install nginx -y
                            elif [ -f /etc/lsb-release ] || [ -f /etc/debian_version ]; then
                                sudo apt update -y
                                sudo apt install nginx -y
                            fi

                            echo "Starting and enabling Nginx..."
                            sudo systemctl start nginx
                            sudo systemctl enable nginx

                            echo "Nginx is running:"
                            sudo systemctl status nginx | head -n 10
                        ENDSSH
                    '''
                }
            }
        }
    }
}
