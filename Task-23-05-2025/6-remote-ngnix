pipeline {
    agent any

    environment {
        SERVER_IP = '44.204.13.61'
    }

    stages {
        stage('Deploy Nginx on Remote Server') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ssh-private-key-ec2',
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {
                        sh """
                            ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${SSH_USER}@${SERVER_IP} << 'ENDSSH'
                            echo "Logged in as: \$(whoami)"
                            echo "Running on: \$(hostname)"

                            echo "Updating package list..."
                            sudo apt-get update -y || sudo yum update -y

                            echo "Installing Nginx..."
                            if command -v apt-get >/dev/null; then
                                sudo apt-get install -y nginx
                            elif command -v yum >/dev/null; then
                                sudo yum install -y nginx
                            fi

                            echo "Starting and enabling Nginx..."
                            sudo systemctl start nginx
                            sudo systemctl enable nginx

                            echo "Nginx status:"
                            sudo systemctl status nginx | head -n 10
                            ENDSSH
                        """
                    }
                }
            }
        }
    }
}
