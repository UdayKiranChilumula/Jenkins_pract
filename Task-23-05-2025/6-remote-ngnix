pipeline {
    agent any

    environment {
        SERVER_IP = '44.204.13.61' // Replace with your EC2 public IP
    }

    stages {
        stage('Deploy Nginx on Amazon Linux EC2') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'ssh-private-key-ec2', // Jenkins SSH key credential ID
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {
                        sh """
                            ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${SSH_USER}@${SERVER_IP} << 'ENDSSH'
                            echo "Logged in as: \$(whoami)"
                            echo "Running on: \$(hostname)"

                            echo "Updating system packages using dnf..."
                            sudo dnf update -y

                            echo "Installing Nginx using dnf..."
                            sudo dnf install -y nginx

                            echo "Starting and enabling Nginx service..."
                            sudo systemctl start nginx
                            sudo systemctl enable nginx

                            echo "Nginx status:"
                            sudo systemctl status nginx | head -n 10
                            ENDSSH
                        """
                    }
                }
            }
        }
    }
}
